# Build iOS IPA for eqmsapp (runs on macOS; requires Apple code signing secrets).
name: Build iOS IPA

on:
  workflow_dispatch:  # Run manually from Actions tab
  push:
    branches: [main]
    paths:
      - 'lib/**'
      - 'ios/**'
      - 'pubspec.yaml'
      - '.github/workflows/build-ios-ipa.yml'

jobs:
  build:
    name: Build IPA
    runs-on: macos-14  # macOS 14 (Sonoma) for Xcode 15
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios && pod install --repo-update && cd ..

      # Code signing: only when secrets are provided
      - name: Create keychain and import certificate
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 != '' }}
        env:
          BUILD_KEYCHAIN: build.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$BUILD_KEYCHAIN"
          security set-keychain-settings -lut 21600 "$BUILD_KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$BUILD_KEYCHAIN"
          security list-keychains -d user -s "$BUILD_KEYCHAIN"
          echo "Importing certificate..."
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$BUILD_KEYCHAIN" -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$BUILD_KEYCHAIN"
          rm -f certificate.p12

      - name: Install provisioning profile
        if: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 != '' }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Configure code signing for CI (with secrets)
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 != '' && secrets.APPLE_PROVISIONING_PROFILE_BASE64 != '' }}
        run: |
          echo "CODE_SIGN_STYLE = Manual" > ios/Flutter/CI.xcconfig
          echo "DEVELOPMENT_TEAM = ${{ secrets.DEVELOPMENT_TEAM_ID }}" >> ios/Flutter/CI.xcconfig
          echo "PROVISIONING_PROFILE_SPECIFIER = ${{ secrets.PROVISIONING_PROFILE_NAME }}" >> ios/Flutter/CI.xcconfig
          echo "CODE_SIGN_IDENTITY = Apple Distribution" >> ios/Flutter/CI.xcconfig

      - name: Configure for no-signing build (no secrets)
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 == '' || secrets.APPLE_PROVISIONING_PROFILE_BASE64 == '' }}
        run: |
          # Without secrets, avoid "development team required". Manual + identity "-" = do not sign.
          printf 'CODE_SIGN_STYLE = Manual\nCODE_SIGN_IDENTITY = -\nDEVELOPMENT_TEAM =\n' > ios/Flutter/CI.xcconfig

      - name: Build IPA (with signing)
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 != '' && secrets.APPLE_PROVISIONING_PROFILE_BASE64 != '' }}
        run: flutter build ipa

      - name: Build iOS only (no signing - verify project compiles)
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 == '' || secrets.APPLE_PROVISIONING_PROFILE_BASE64 == '' }}
        run: |
          echo "::notice::Code signing secrets not set. Add secrets to produce IPA. See .github/IOS_IPA_SECRETS.md"
          flutter build ios --release --no-codesign

      - name: Upload IPA artifact
        if: ${{ success() && secrets.APPLE_CERTIFICATE_BASE64 != '' && secrets.APPLE_PROVISIONING_PROFILE_BASE64 != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/

      - name: Build summary
        if: always()
        run: |
          echo "## iOS build summary" >> $GITHUB_STEP_SUMMARY
          if [ -d build/ios/ipa ] && [ -n "$(ls -A build/ios/ipa 2>/dev/null)" ]; then
            echo "✅ IPA built. Download from the **Actions** tab → this run → **Artifacts**." >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No IPA (expected if code signing secrets are not set). See `.github/IOS_IPA_SECRETS.md` to configure." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash
